Immunoprofiling of adenocarcinomas of the pancreatobiliary tree
===============================================================
Semisupervised hierarchical cluster analysis
============================================

Generated on: `r Sys.time()`

Import required packages
```{r}
# Build pre-requisites
#install.packages("extrafonts")
#install.packages("gplots")
#install.packages("amap")
library(gplots)
library(amap)
library(extrafont)
```

Configure file names
```{r}

myWorkDirectory <- "~/tfcb-homework08/data/"
imputedDataFileName <- paste(myWorkDirectory, "tidy/imputed_data.csv", sep="")
clusteredFileName <- paste(myWorkDirectory, "tidy/clustered.csv", sep="")

```

Import imputed dataset
```{r}
pcbilDataImputed <- read.csv(file = imputedDataFileName, colClasses= c("character",rep("numeric",26), "factor"), na.strings = "",quote="\"" )
```


Prepare clustering color key
```{r}
imputedMatrix <- t(as.matrix(pcbilDataImputed[, 2:28]))


clinDiagColorMap <- function(clin_diag) { 
  if (clin_diag == "Hepatocellular carcinoma") {
    "green"
  } else if (clin_diag == "Intrahepatic cholangiocarcinoma") {
    "blue"
  } else if (clin_diag == "Perihilar cholangiocarcinoma") {
    "yellow"
  } else if (clin_diag == "Gallbladder cancer") {
    "purple"
  } else if (clin_diag == "Distal bile duct cancer") {
    "deeppink"
  } else if (clin_diag == "Ductal pancreatic adenocarcinoma") {
    "red"
  } else if (clin_diag == "Ampullary carcinoma") {
    "black"
  } else {
    "white"
  } 
}

# Define color keys for tumor samples
colorKeyTumors <- unlist(lapply(pcbilDataImputed$clinical_diagnosis, clinDiagColorMap))
```

Unsupervised hierarchical clustering with Pearson distance and average linkage - colored by anatomical-based diagnoses
```{r fig.width=15, fig.height=10}

imputedMatrix2 <- t(as.matrix(pcbilDataImputed[, 2:27]))

hc <- hclust(Dist(t(imputedMatrix2), method="pearson"), method="average") 
hr <- hclust(Dist(imputedMatrix2, method="pearson"), method="average")

heatmap.2(imputedMatrix2, Rowv=as.dendrogram(hr), Colv=as.dendrogram(hc), col=greenred(100), scale="none", ColSideColors=colorKeyTumors, density.info="none", trace="none")
```


Semisupervised approach - Step 1: perform visual assessment of clusters composition and disposition and identify candidate clusters of interest
```{r fig.width=15, fig.height=10}
colorsUnsupClusters <- c(
                "red", # cl 1 - extrahep-ccc-tuc
                "green4", 
                "green1",
                "blue1", # cl 4 - intrahep-ccc-tuc
                "#FF7F00", # orange
                "blueviolet", # cl 6 - intest-diff-tuc
                "gold1",
                "skyblue2",
                "#FB9A99", # lt pink
                "palegreen2",
                "#CAB2D6", # lt purple
                "dodgerblue2",                
                "#FDBF6F", # lt orange                              
                "gray70",
                "khaki2",
                "maroon",
                "orchid1",
                "deeppink1",
                "#E31A1C", # red
                "steelblue4",
                "darkturquoise",
                "green1",
                "yellow4",
                "yellow3",
                "darkorange4",
                "brown"
)

colorsCandidateClusters <- c(
                "red", # cl 1 - extrahep-ccc-tuc
                "green1", # cl 2 - hcc
                "green1", # cl 3 - hcc
                "blue1", # cl 4 - intrahep-ccc-tuc
                "black", # cl 5 - unclassified
                "blueviolet", # cl 6 - intest-diff-tuc
                "black", # cl 7 - unclassified
                "green1", # cl 8 - hcc
                "green1", # cl 9 - hcc
                "black", # cl 10 - unclassified
                "green1", # cl 11 - hcc
                "green1", # cl 12 - hcc
                "black", # cl 13 - unclassified
                "green1", # cl 14 - hcc
                "black", # cl 15 - unclassified
                "green1", # cl 16 - hcc
                "black", # cl 17 - unclassified
                "black", # cl 18 - unclassified
                "black", # cl 19 - unclassified
                "black", # cl 20 - unclassified
                "black", # cl 21 - unclassified
                "black", # cl 22 - unclassified
                "black", # cl 23 - unclassified
                "green1", # cl 24 - hcc
                "black", # cl 25 - unclassified
                "green1", # cl 26 - hcc
                "black", # cl 27 - unclassified
                "black" # cl 28 - unclassified
                )

# Cut the tree at a defined height to obtain the unsupervised clusters
unsupClusters <- cutree(hc, h=max(hc$height)/2.2)

# Define color keys for unsupervised and candidate clusters
colorKeyUnsupClusters <- colorsUnsupClusters
colorKeyUnsupClusters <- colorKeyUnsupClusters[as.vector(unsupClusters)]
colorKeyCandidateClusters <- colorsCandidateClusters
colorKeyCandidateClusters <- colorKeyCandidateClusters[as.vector(unsupClusters)]

columnColorKeyTUC <- matrix(c(colorKeyCandidateClusters, colorKeyUnsupClusters, colorKeyTumors), ncol=3)
colnames(columnColorKeyTUC) <- c("Candidate clusters", "Unsupervised clusters",  "Anatomical diagnoses")

heatmap.2(imputedMatrix2, Rowv=as.dendrogram(hr), Colv=as.dendrogram(hc), col=greenred(100), scale="none", density.info="none",  ColSideColors=columnColorKeyTUC)
```

Semisupervised approach - Step 2: create clusters of interest by merging adjacent clusters with homogeneous composition (from previously identified candidate clusters)
```{r  fig.width=15, fig.height=10}
# Function to merge clusters according to visual assessment
mergeClusters <- function(origCl) {
  origCl[origCl == 1] <- 'extrahepatic pancreatobiliary'
  origCl[origCl == 2 | origCl == 3 | origCl == 8 | origCl == 9 | origCl == 11 | origCl == 12 | origCl == 14 | origCl == 16 | origCl == 24 | origCl == 26] <- 'hepatocellular carcinoma'
  origCl[origCl == 4] <- 'intrahepatic cholangiocarcinoma'
  origCl[origCl == 6] <- 'intestinal'
	origCl[origCl == 5 | origCl == 7 | origCl == 10 | origCl == 13 | origCl == 15 | origCl == 17 | origCl == 18 | origCl == 19 | origCl == 20 | origCl == 21 | origCl == 22 |   origCl == 23 | origCl == 25 | origCl == 27 | origCl == 28] <- 'unclassified'
	
	origCl
}

# Merge unsupervised clusters into clusters of interest
mergedClusters <- mergeClusters(unsupClusters)

# Define color key for semisupervised clusters
colorsSemisupClusters <- c(
                "extrahepatic pancreatobiliary" = "red", # cl 1 - extrahep-ccc-tuc
                "hepatocellular carcinoma" = "green1", # cl 2 - hcc
                "intrahepatic cholangiocarcinoma" = "blue1", # cl 4 - intrahep-ccc-tuc
                "unclassified" = "black", # cl 5 - unclassified
                "intestinal" = "blueviolet" # cl 6 - intest-diff-tuc                
                )
colorKeySemisupClusters <- colorsSemisupClusters
colorKeySemisupClusters <- colorKeySemisupClusters[as.vector(mergedClusters)]

columnColorKeyCS <- matrix(c(colorKeySemisupClusters, colorKeyCandidateClusters), ncol=2)
colnames(columnColorKeyCS) <- c("Semisupervised clusters", "Candidate clusters")

# Show color key for candidate and the newly created semisupervised clusters to verify the latter were correctly created (by matching the former)
heatmap.2(imputedMatrix, Rowv=as.dendrogram(hr), Colv=as.dendrogram(hc), col=greenred(100), scale="none", density.info="none",  ColSideColors=columnColorKeyCS)

# The ordered version of the dendrogram illustrates the spectrum of differentiation of hepato-pancreato-biliary tumors
heatmap.2(imputedMatrix, col=greenred(100), scale="none", key= FALSE, symkey=FALSE, density.info="none", trace="none", cexRow=1.0, cexCol= 0.4, distfun=function(x) Dist(x,method= "pearson"), main= paste("Dist(pearson):", "hclust(average)", sep=""), hclustfun = function(x) hclust(x, method = "average"), ColSideColors=columnColorKeyCS)
```

Expository figure
```{r  fig.width=15, fig.height=10}
colorsSemisupClustersExp <- c(
                "extrahepatic pancreatobiliary" = "red", 
                "hepatocellular carcinoma" = "green1", 
                "intrahepatic cholangiocarcinoma" = "blue1", 
                "unclassified" = "white", 
                "intestinal" = "blueviolet" 
                )

colorKeySemisupClustersExp <- colorsSemisupClustersExp
colorKeySemisupClustersExp <- colorKeySemisupClustersExp[as.vector(mergedClusters)]

columnColorKeyTS <- matrix(c(colorKeySemisupClustersExp, colorKeyTumors), ncol=2)
colnames(columnColorKeyTS) <- c("Immunohistochemical clusters",  "Anatomical diagnoses")

heatmap.2(imputedMatrix, Rowv=as.dendrogram(hr), Colv=as.dendrogram(hc), col=greenred(100), scale="none", density.info="none",  ColSideColors=columnColorKeyTS)



pdf( paste(myWorkDirectory, "data_analysis/out/hierarchical_clust.pdf",sep=""), width = 8, height = 6,family="Arial")

par(oma=c(0,2,0,0))
heatmap.2(imputedMatrix, Rowv=as.dendrogram(hr), Colv=as.dendrogram(hc), col=greenred(100), scale="none", density.info="none",  ColSideColors=columnColorKeyTS)
title(outer=T,adj=0,main="A",cex=1.1, col="black",font.main=1, line=-3, cex.main=3.5,)

dev.off()
```

Save clustered dataset
```{r}
pcbilDataImputed$cluster <- mergedClusters
pcbilDataImputed$pad <- rownames(pcbilDataImputed)
write.csv(pcbilDataImputed, clusteredFileName, row.names=F, na="")
```

-- End of hierarchical cluster analysis --